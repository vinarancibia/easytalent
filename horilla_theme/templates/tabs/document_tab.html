{% load i18n static %}

<div class="oh-btn-group p-3 d-flex justify-between">
	<span class="text-md font-semibold"> {% trans "Documents" %}</span>
	<div>
		<button
			class="oh-btn oh-btn--secondary"
			data-toggle="oh-modal-toggle"
			data-target="#genericModal"
			hx-get="{% url 'document-create' emp_id %}"
			hx-target="#genericModalBody"
			onclick="event.preventDefault()"
		>
			<ion-icon name="add-sharp" class="mr-2"></ion-icon>{% trans "Create" %}
		</button>
	</div>
</div>
{% if documents %}
	<div class="p-6">
		<div class="bg-white rounded-xl shadow-sm overflow-hidden">
			<div
				class="hidden md:grid grid-cols-[60px_1fr_120px_120px_180px] gap-4 px-6 py-4 bg-slate-50 border-b border-slate-200 text-xs font-semibold uppercase tracking-wider text-slate-500 items-center"
			>
				<div></div>
				<div>{% trans "Document" %}</div>
				<div>{% trans "Status" %}</div>
				<div>{% trans "Date" %}</div>
				<div>{% trans "Actions" %}</div>
			</div>

			{% for document in documents %}
				<div
					class="grid md:grid-cols-[60px_1fr_120px_120px_180px] gap-4 px-6 py-4 border-b border-slate-100 items-center hover:bg-slate-50 cursor-pointer
						{% if document.document %}
							{% if document.status == "approved" %}row-status--yellow
							{% elif document.status == 'rejected' %}row-status--red
							{% elif document.status == 'requested' %}row-status--blue
							{% endif %}
						{% endif %}
					"
					hx-get="{% url 'view-file' document.id %}"
					hx-target="#viewFile"
					data-toggle="oh-modal-toggle"
					data-target="#viewFileModal"
					id="document{{document.id}}"
				>
					{% if document.document %}
						{% if document.status == "approved" %}
							<div
								class="w-8 h-8 rounded-md bg-green-100 text-green-700 flex items-center justify-center shrink-0"
							>
								<ion-icon name="checkmark-outline"></ion-icon>
							</div>
						{% elif document.status == 'rejected' %}
							<div
								class="w-8 h-8 rounded-md bg-red-100 text-red-600 flex items-center justify-center shrink-0"
							>
								<ion-icon name="warning-outline"></ion-icon>
							</div>
						{% else %}
							<div
								class="w-8 h-8 rounded-md bg-blue-100 text-blue-600 flex items-center justify-center shrink-0"
							>
								<ion-icon name="document-text-outline"></ion-icon>
							</div>
						{% endif %}
					{% else %}
						<div
							class="w-8 h-8 rounded-md bg-amber-100 text-amber-700 flex items-center justify-center shrink-0"
						>
							<ion-icon name="cloud-upload-outline"></ion-icon>
						</div>
					{% endif %}

					<div class="w-full">
						<div class="title-wrapper">
							<div
								onclick="event.stopPropagation()"
								class="font-semibold text-slate-900 mb-1 hover:bg-slate-100 px-1 rounded inline-block {% if document.document_request_id %} cursor-pointer {% else %} cursor-text title-display {% endif %}">
								{{ document.title }}
							</div>

							<input type="text"
								name="title"
								data-id="{{document.id}}"
								class="hidden font-semibold text-slate-900 mb-1 cursor-text border border-slate-300 rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-300 w-full title-input"
								value="{{ document.title }}"
								onclick="event.stopPropagation();"
							>
						</div>

						<div class="text-sm text-slate-500">
							{{document.document_request_id.description}}
						</div>
					</div>

					<div>
						<div
							class="text-sm font-medium px-3 py-1 rounded-xl text-center {% if document.document %} {% if document.status == 'approved' %}bg-green-100 text-green-700 {% elif document.status == 'rejected' %}bg-red-100 text-red-700 {% elif document.status == 'requested' %}bg-blue-100 text-blue-700 {% endif %} {% else %} bg-amber-100 text-amber-700 {% endif %}"
						>
							{% if document.document %} {{document.status}}
							{% else %} {% trans "No Document" %}
							{% endif %}
						</div>
					</div>

					<div class="text-sm text-slate-500 font-medium">
						{% if document.issue_date %}<span class="dateformat_changer"> {{document.issue_date}}</span>{% else %} - {% endif %}
					</div>

					<div class="flex gap-1 w-full">
						{% if document.document %}
							{% if perms.horilla_document.change_documentrequest %}
								{% if document.status == "approved" %}
									<button
										class="oh-btn flex-1 text-base bg-green-100 text-green-700 hover:bg-green-200 hover:scale-105 opacity-50 cursor-not-allowed"
										title="{% trans 'Approve' %}"
									>
										<ion-icon class="me-1" name="checkmark-outline"></ion-icon>
									</button>

									<button
										class="oh-btn flex-1 text-base bg-red-100 text-red-600 hover:bg-red-200 hover:scale-105 transition"
										hx-get="{% url 'document-reject' document.id %}"
										hx-target="#genericModalBody"
										data-toggle="oh-modal-toggle"
										data-target="#genericModal"
										title="{% trans 'Reject' %}"
										onclick="event.stopPropagation()"
									>
										<ion-icon class="me-1" name="close-outline"></ion-icon>
									</button>
								{% else %}
									<button
										class="oh-btn flex-1 text-base bg-green-100 text-green-700 hover:bg-green-200 hover:scale-105"
										hx-get="{% url 'document-approve' document.id %}"
										title="{% trans 'Approve' %}"
										onclick="event.stopPropagation()"
									>
										<ion-icon class="me-1" name="checkmark-outline"></ion-icon>
									</button>
									<button
										class="oh-btn flex-1 text-base bg-red-100 text-red-600 hover:bg-red-200 hover:scale-105 transition opacity-50 cursor-not-allowed"
										title="{% trans 'Reject' %}"
									>
										<ion-icon class="me-1" name="close-outline"></ion-icon>
									</button>
								{% endif %}
							{% endif %}
						{% else %}
							<button
								class="oh-btn flex-1 text-base bg-amber-100 text-amber-600 hover:bg-amber-200 hover:scale-105 transition"
								title="{% trans 'Upload Document' %}"
								hx-get="{% url 'file-upload' document.id %}"
								hx-target="#genericModalBody"
								data-document-id="{{ document.id }}"
								data-toggle="oh-modal-toggle"
								data-target="#genericModal"
								onclick="event.stopPropagation()"
							>
								<ion-icon
									class="me-1"
									name="cloud-upload-outline"
								></ion-icon>
							</button>
						{% endif %}

						{% if not document.document_request_id or perms.horilla_document.change_documentrequest %}
							<form
								hx-confirm="{% trans 'Are you sure you want to delete this Document Request?' %}"
								hx-post="{% url 'document-delete' document.id %}"
								hx-target="#document{{document.id}}"
								hx-swap="outerHTML"
								hx-on-htmx-after-request="setTimeout(() => { reloadMessage(); }, 300);"
								onclick="event.stopPropagation()"
							>
								{% csrf_token %}
								<button
									type="submit"
									class="oh-btn text-base bg-slate-100 text-slate-500 hover:scale-105 hover:text-red-500 transition"
									title="{% trans 'Delete' %}"
								>
									<ion-icon class="me-1" name="trash-outline"></ion-icon>
								</button>
							</form>
						{% endif %}
					</div>
				</div>
			{% endfor %}
		</div>
	</div>

{% else %}

	<div class="oh-wrapper h-full" align="center">
		<div
			class="xl:col-span-4 md:col-span-6 col-span-12 bg-white p-6 rounded-md shadow-card h-[70%]"
		>
			<div class="flex flex-col items-center justify-center h-full">
				<img
					src="/static/horilla_theme/assets/img/no-records.svg"
					alt=""
					width="300"
					class="mb-4"
				/>
				<p class="text-[#666] mb-5">
					{% trans "No documents have been uploaded yet." %}
				</p>
			</div>
		</div>
	</div>

{% endif %}

<div
	class="oh-modal"
	id="viewFileModal"
	role="dialog"
	aria-labelledby="viewFileModal"
	aria-hidden="true"
>
	<div class="oh-modal__dialog custom-dialog">
		<div class="oh-modal__dialog-header">
			<span class="oh-modal__dialog-title" id="viewFileModalLabel"
				>{% trans "View File" %}</span
			>
			<button class="oh-modal__close" aria-label="Close">
				<ion-icon
					name="close-outline"
					role="img"
					class="md hydrated"
					aria-label="close outline"
				></ion-icon>
			</button>
		</div>
		<div class="oh-modal__dialog-body" id="viewFile"></div>
	</div>
</div>

<script>
	$(document).ready(function () {

		$('.title-wrapper').each(function () {
			const $wrapper = $(this);
			const $display = $wrapper.find('.title-display');
			const $input = $wrapper.find('.title-input');

			$display.on('click', function () {
				$display.addClass('hidden');
				$input
					.val($display.text().trim())
					.removeClass('hidden')
					.focus()
					.select();
			});

			$input.on('blur', function () {
				const newTitle = $input.val().trim() || 'Untitled';
				$wrapper.find('.title-error').remove();

				if (newTitle.length < 3) {
					$('<div class="title-error text-red-500 text-sm mt-1">Title must be at least 3 characters.</div>')
					.insertAfter($(this));
					$(this).focus();
					return;
				}

				$display.text(newTitle).removeClass('hidden');
				$input.addClass('hidden');
				id = $input.data("id")
				if ($display.text().trim() !== newTitle) {
					$.ajax({
						url: `/employee/update-document-title/${id}`,
						method: 'POST',
						headers: {
							'X-CSRFToken': '{{ csrf_token }}'
						},
						data: { "title": newTitle },
						success: function () {
							reloadMessage()
						}
					});
				}
			})

			$input.on('keyup', function(event) {
				if ($(this).val().length > 3){
					$(".title-error").hide()
				}
				if (event.key === "Enter") {
					$(this).blur()
				}
			});
		});

	});

</script>
